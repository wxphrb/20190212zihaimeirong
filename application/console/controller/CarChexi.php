<?phpnamespace app\console\controller;use think\Db;use think\Request;use think\Url;use app\console\model\CarChexi as ThisModel;use app\console\model\NewsInfo;class CarChexi extends Base{    public $arr_type=[];    /**     * [index description]列表     * @return [type] [description]     */    public function index(ThisModel $carChexi, Request $request)    {        $type_id = array();        $name = array();        $where = '';        if (Request::instance()->param()) {            $name = $request->param("name");            if ($name) {                $where = [                    'c.p_chexi|b.p_pinpai' => ['like', '%' . $name . '%'],                ];                $this->assign('name',$name);            }        }        $listRows = $this->show_num ? $this->show_num : 20 ;        $data = $carChexi            ->alias('c')            ->join('car_brand b','c.p_pinpai_id = b.p_pinpai_id')            ->where($where)            ->order(['c.status'=>'desc','c.p_pinpai_id'=>'asc'])            ->field('c.id,b.p_pinpai,c.p_pinpai_id,c.p_chexi,c.p_chexi_id,c.p_chexizhanshitu,c.status')            ->paginate($listRows);        $param = ['list' => $data];        return $this->fetch('index', $param);    }    /**     * [create description]添加方法     * @return [type] [description]     */    public function create()    {        if (Request::instance()->isPOST()) {            $data = Request::instance()->post();            $p_chexi_id = ThisModel::max('p_chexi_id');            $data['p_chexi_id'] = $p_chexi_id+1;            $result = ThisModel::saveVerify($data);            if (true === $result) {                $this->success('新建成功', 'console/CarChexi/index');            } else {                $this->error($result);            }        }        $param = $this->appendarg();        $this->assign('cartype',$this->appendarg());        return $this->fetch('create');    }    /**     * [update description]更新方法     * @param  [type] $id [description]主键id     * @return [type]     [description]     */    public function update($id)    {        if (Request::instance()->isPOST()) {            $data = Request::instance()->post();            $result = ThisModel::saveVerify($data, $id);            if (true === $result) {                $this->success('更新成功', 'console/CarChexi/index');            } else {                $this->error($result);            }        }        $data = ThisModel::get($id);        $this->assign('cartype',$this->appendarg());        $param = array_merge(['vo' => $data], $this->appendarg());        return $this->fetch('create', $param);    }    /**     * 添加修改时候需要传递参数的话，用此方法，只写一遍     */    public function appendarg()    {        $this->showtype(0);        return $this->arr_type;    }    /**     * [delete description]删除方法 多选和单选删除     * @return [type] [description]     */    public function delete()    {        if (Request::instance()->isPOST()) {            $id = Request::instance()->post('id/a'); // (/a)方法 将收到的id转为数组            $delmodel = ThisModel::destroy($id);            if ($delmodel) {                $this->success('删除成功', 'console/CarChexi/index');            } else {                $this->error($delmodel->getError());            }        } else {            $this->error('请求方式出错!');        }    }    /**     * [renewfield description]列表更新字段     * @return [type] [description]     */    public function renewfield()    {		$page = Request::instance()->param('page');        if (Request::instance()->isPOST()) {            $data = Request::instance()->post();            $validate = validate('CarChexi');            $post = Request::instance()->except(['id'], 'post');            $post = array_keys($post);            $validate->scene('edit', $post);            if (!$validate->scene('edit')->check($data)) {                $this->error($validate->getError());            }            $this_model = new ThisModel();            if (Db::name('car_chexi')->update($data)) {				$name = Request::instance()->param('name');								if(!empty($page)){					 if(empty($name)){						 $this->success('更新成功', url('console/CarChexi/index').'?page='.$page);					 }else{						 $this->success('更新成功', url('console/CarChexi/index').'?page='.$page.'&name='.urldecode($name));					 }					 //$this->redirect('OldCar/index', ['page' => $page]);				}else{					 $this->success('更新成功', 'console/CarChexi/index');				}            } else {                $this->error($this_model->getError());            }        } else {            $this->error('请求方式出错!');        }    }    public  function hot_state() {        $param = Request::instance()->param();        if($param['hot_state'] == 1) {            $a = Db::name('bbc_question')->where('id',$param['id'])->update(['hot_state'=>1]);            $this->success('更新成功', 'console/bbc_question/index');        } else {            $a = Db::name('bbc_question')->where('id',$param['id'])->update(['hot_state'=>0]);            $this->success('更新成功', 'console/bbc_question/index');        }    }    public function  chexi_channel(){         $this->db   = db('car_chexi');         $chexi_list = db('new_car')->field('p_pinpai_id,p_chexi,p_pinpai,p_chexizhanshitu,p_chexi_id')->group('p_chexi_id')->select();         foreach($chexi_list as $v){           $data['p_pinpai_id']      = $v['p_pinpai_id'];           $data['p_chexi']          = $v['p_chexi'];           $data['p_chexizhanshitu'] = $v['p_chexizhanshitu'];           $data['p_chexi_id']       = $v['p_chexi_id'];           //$this->db->insert($data);         }    }    public function showtype($id=0, $i=0){        /* $res = db::name('car_brand')->field('id,name,picurl')->where('parentid',$id)->order('orderid','asc')->select();*/        /* $res = db('car_brand')->alias('b')             ->join('new_car n','n.p_pinpai_id = b.p_pinpai_id')             ->field('n.p_pinpai,n.p_chexi')             ->where('b.status',1)             ->order('b.p_shouzimu')             ->paginate(10);*/        $res = db::name('car_brand')->field('id,p_pinpai_id,p_pinpai,p_shouzimu')->where('status',1)->order('p_shouzimu')->select();        foreach($res as &$v){            $title='';            for($p=1; $p<$i; $p++){                $title.='&nbsp;&nbsp;&nbsp;';            }            /*            if($v['p_pinpai_id'] != 0){                $title.='|- ';            }*/            $title.=$v['p_pinpai'];            $v['p_pinpai'] =$v['p_shouzimu'].'--'. $title;            array_push($this->arr_type, $v);            //$this->showtype($v['id'], $i+2);        }    }    public function update_car_chexi($limit=0,$size=250){        set_time_limit(0);      //执行时间无限        ini_set('memory_limit', '-1');    //内存无限        $this->db_n = db('car_chexi');        $this->db_o = db('config_series');        $getLastInsID = 0;        //for($i = 32;$i<66;$i++){        if($limit == 0){            $k     = 0;        }else{            $k     = $limit+$size;//17:26:54        }        $o_res = $this->db_o->limit($k,$size)->select();        $i = 0;        foreach($o_res as $v){            $res_e = $this->db_n->where(['p_chexi_id'=>$v['p_chexi_id']])->find();            if(!$res_e){                $data['p_chexi']          = $v['p_chexi'];                $data['p_chexi_id']       = $v['p_chexi_id'];                $data['p_chexizhanshitu'] = '/'.$v['p_chexizhanshitu'];                $data['p_pinpai_id']      = $v['p_pinpai_id'];                $data['status']           = 1;                $this->db_n->insert($data);                /*$getLastInsID = $this->db_n->getLastInsID();                echo $getLastInsID."<br>";*/            }        }        //sleep(2);        //}        echo $k.'---'.date('Y-m-d H:i:s');        exit;    }}