<?phpnamespace app\console\controller;use think\Db;use think\Request;use think\Url;use app\console\model\CarBrand as ThisModel;use app\console\model\NewsInfo;class CarBrand extends Base{    /**     * [index description]列表     * @return [type] [description]     */    public function index(ThisModel $CarBrand, Request $request)    {        //set_time_limit(0);        //ini_set('memory_limit', '18M');        /* 修改原表内logo地址        $res = db('car_brand')->field('id,p_pinpai,p_pinpai_logo')->select();        foreach($res as $v){            $a = str_replace('Logo/','/logo/',$v['p_pinpai_logo']);          // $b =  db('car_brand')->update(['id'=>$v['id'],'p_pinpai_logo'=>$a]);        }*/        /*        $this->db = db('new_car');        $res = $this->db->field('id,p_changshangzhidaojia_yuan')->where('car_price',0)->select();        wcc($res);        foreach($res as $v){            $a        = str_replace('万','',$v['p_changshangzhidaojia_yuan']);            $new_data = $a*10000;            $b        =  $this->db->update(['id'=>$v['id'],'car_price'=>$new_data]);        }        */        $type_id = array();        $name = array();        $where = '';        if (Request::instance()->isPost()) {            $name = $request->param("name");            if ($name) {                $where = [                    'p_pinpai|p_shouzimu' => ['like', '%' . $name . '%'],                ];                $this->assign('name',$name);            }        }        $listRows = $this->show_num ? $this->show_num : 20 ;        $data = $CarBrand            ->where($where)            ->order(['status'=>'desc','p_shouzimu'=>'asc'])            ->paginate($listRows);        $param = array_merge(['list' => $data], $this->appendarg());        return $this->fetch('index', $param);    }    /**     * [create description]添加方法     * @return [type] [description]     */    public function create()    {        if (Request::instance()->isPOST()) {            $data = Request::instance()->post();            $p_pinpai_id = ThisModel::max('p_pinpai_id');            $data['p_pinpai_id'] = $p_pinpai_id+1;            $result = ThisModel::saveVerify($data);            if (true === $result) {                $this->success('新建成功', 'console/CarBrand/index');            } else {                $this->error($result);            }        }        $param = $this->appendarg();        $letters = [];        for($i=ord('A'); $i<=ord('Z'); $i++)        {            $letters[]['name'] =  chr($i) ;        }        $this->assign('letters',$letters);        return $this->fetch('create', $param);    }    /**     * [update description]更新方法     * @param  [type] $id [description]主键id     * @return [type]     [description]     */    public function update($id)    {        if (Request::instance()->isPOST()) {            $data = Request::instance()->post();            $result = ThisModel::saveVerify($data, $id);            if (true === $result) {                $this->success('更新成功', 'console/CarBrand/index');            } else {                $this->error($result);            }        }        $letters = [];        for($i=ord('A'); $i<=ord('Z'); $i++)        {            $letters[]['name'] =  chr($i) ;        }        $this->assign('letters',$letters);        $data = ThisModel::get($id);        $param = array_merge(['vo' => $data], $this->appendarg());        return $this->fetch('create', $param);    }    /**     * 添加修改时候需要传递参数的话，用此方法，只写一遍     */    public function appendarg()    {        return [            //添加参数            /*'type_title' => Db::name("bbc_type")->where("status", 1)->field("id,type_title")->select(),*/        ];    }    /**     * [delete description]删除方法 多选和单选删除     * @return [type] [description]     */    public function delete()    {        if (Request::instance()->isPOST()) {            $id = Request::instance()->post('id/a'); // (/a)方法 将收到的id转为数组            $delmodel = ThisModel::destroy($id);            if ($delmodel) {                $this->success('删除成功', 'console/CarBrand/index');            } else {                $this->error($delmodel->getError());            }        } else {            $this->error('请求方式出错!');        }    }    /**     * [renewfield description]列表更新字段     * @return [type] [description]     */    public function renewfield()    {		$page = Request::instance()->param('page');        if (Request::instance()->isPOST()) {            $data = Request::instance()->post();            $validate = validate('CarBrand');            $post = Request::instance()->except(['id'], 'post');            $post = array_keys($post);            $validate->scene('edit', $post);            if (!$validate->scene('edit')->check($data)) {                $this->error($validate->getError());            }            $this_model = new ThisModel();            if (Db::name('car_brand')->update($data)) {								if(!empty($page)){					 $this->success('更新成功', url('console/CarBrand/index').'?page='.$page);					 //$this->redirect('OldCar/index', ['page' => $page]);				}else{					 $this->success('更新成功', 'console/CarBrand/index');				}            } else {                $this->error($this_model->getError());            }        } else {            $this->error('请求方式出错!');        }    }    public  function hot_state() {		$page = Request::instance()->param('page');        $param = Request::instance()->param();        if($param['hot_state'] == 1) {            $a = Db::name('bbc_question')->where('id',$param['id'])->update(['hot_state'=>1]);			if($a){				$this->success('设置推荐成功', url('console/bbc_question/index').'?page='.$page);			}else{				 $this->error('更新失败','console/bbc_question/index');			}                    } else {            $a = Db::name('bbc_question')->where('id',$param['id'])->update(['hot_state'=>0]);			if($a){				$this->success('取消推荐成功', url('console/bbc_question/index').'?page='.$page);			}else{				 $this->error('更新失败','console/bbc_question/index');			}        }    }}