<?php/** * Created by PhpStorm. * User: Administrator * Date: 2018/1/4 * Time: 10:28 */namespace app\api\controller;use app\api\model\Supply as SupplyModel;use app\api\model\User;use mrmiao\encryption\RSACrypt;use think\Controller;use think\Db;use think\Request;class Supply extends Controller{    /*     * 供求平台---1、列表     */    public function index(RSACrypt $crypt, SupplyModel $supply, User $user)    {        $request = $crypt->request();        //帖子列表 筛选条件 分类id 关键词        $where['status'] = 1;        $where['state'] = 2;        if (!empty($request['keyword'])) {            $where['title'] = ['like', '%' . $request['keyword'] . '%'];        }        //列表        $data = $supply->where($where)->field('id,title,address,user_id,state,create_time')->order('id desc')->paginate(10, false, ['page' => $request['page']]);        foreach ($data as &$v) {            $v['username'] = $user->where('id', $v['user_id'])->value('username');            $v['picurl'] = $user->where('id', $v['user_id'])->value('picurl');            $certification = Db::name('certification')->where(['user_id' => $v['user_id']])->value('certification_type');            if (empty($certification)) {                $v['level'] = 0;                $v['level_title'] = "普通";            } else {                $v['level'] = $certification;                $v['level_title'] = Db::name('certification_type')->where('id', $certification)->value('title');            }        }        return $crypt->response([            'code' => 200,            'message' => "成功",            'data' => $data,        ]);    }    /*    * 供求平台---2、供求详情     * 参数：供求的id    */    public function info(RSACrypt $crypt, User $user, SupplyModel $supply)    {        $request = $crypt->request();//        echo 1;die;//        dump($request);die;        Db::name('news_info')->where(['user_id' => $request['user_id'], 'other_id' => $request['id'], 'read_state' => 0, 'type' => 3])->update(['read_state' => 1]);        $data = $supply->where('id', $request['id'])->field('id,title,user_id,create_time,address')->find();                $data['username'] = $user->where('id', $data['user_id'])->value('username');        $data['picurl'] = $user->where('id', $data['user_id'])->value('picurl');        $data['content'] = "http://www.wantaozb.com/index.php/api/Supply/infoweb?id=" . $request['id'];        if ($request['user_id'] != '') {            $collect = Db::name("collection")                ->where([                    'type' => 4,                    "collection_id" => $request['id'],                    'user_id' => $request['user_id']                ])                ->find();            $data['collection_id'] = empty($collect['id']) ? "" : $collect['id'];            $data['collection'] = empty($collect) ? 0 : 1;        } else {            $data['collection_id'] = "";            $data['collection'] = 0;        }        //身份标识        $data['level_id'] = $user->where('id', $data['user_id'])->value('level_id');        $data['level_title'] = Db::name('certification_type')->where('id', $data['level_id'])->value('title');        return $crypt->response([            'code' => 200,            'message' => "成功",            'data' => $data,        ]);    }    /*       * 供求平台---供求详情web        * 参数：供求的id       */    public function infoWeb(Request $request, SupplyModel $supply)    {        $post_data = $request->param();        $content = $supply->where("id", $post_data['id'])->value("content");        return make_show($content);    }    /*      * 供求平台---我要供应/供求      */    public function supplyAdd(RSACrypt $crypt, SupplyModel $supply)    {        $request = $crypt->request();        $result = $this->validate($request, 'Supply.supplyAdd');        if ($result !== true) {            return $crypt->response([                'code' => 400,                'message' => $result            ]);        }        $data = $supply->allowField(true)->isUpdate(false)->save($request);        if ($data) {            return $crypt->response([                'code' => 200,                'message' => "成功",            ]);        }    }}