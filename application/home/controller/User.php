<?php/** * Created by PhpStorm. * User: Administrator * Date: 2018/1/4 * Time: 10:28 */namespace app\home\controller;use app\api\model\IndustryInformation as IndustryInformationModel;use mrmiao\encryption\RSACrypt;use think\Controller;use think\Db;use think\Request;use think\Session;use app\home\model\User as ThisUser;use app\home\model\MoneyDetail;class User extends Base{    protected function _initialize()    {        parent::_initialize();        //底部默认选中        $this->assign('mo_foot',3);    }   /* todo 我的    *    * */    public function index(){        //用户信息        $param = Request::instance()->param();        $user_id = Session::get('user_id');        $userfind = ThisUser::where('id',$user_id)->find();//        dump($userfind);die;        $data = [          'title' => '',          'desc' => '',          'imgUrl' => '',          'link' => 'http://www.xxxxxx.com/home/share/index/user_id/'.Session::get('user_id'),        ];        return $this->fetch('index',[                'title'=>"我的",                'vo'=>$userfind,                'data'=>$data,            ]        );    }    /* todo 个人资料     *     * */    function personal_data() {        $user_id = Session::get('user_id');        return $this->fetch('personal_data',[            'title'=>"个人资料",            'vo'=>ThisUser::where('id',$user_id)->find(),        ]);    }    /* todo 修改头像     *     * */    function touxiang() {        $param = Request::instance()->param();        $url = "http://".$_SERVER['SERVER_NAME']."/".$param['avatar'];        ThisUser::where('id',Session::get('user_id'))->update(['picurl'=>$url]);        return $url;//        dump($param);    }    /* todo 修改昵称     *     * */    function update_username() {        if(Request::instance()->isPost()) {            $username = Request::instance()->param('username');            $a = ThisUser::where('id',Session::get('user_id'))->update(['username'=>$username]);            if($a) {                return 1; //成功            } else {                return 2; //失败            }        }        return $this->fetch('update_username',[            'title'=>"修改昵称",            'username'=>Request::instance()->param('username'),        ]);    }    /*佣金明细*/    public function money_detail(ThisUser $user,MoneyDetail $detail){        $user_id      = Session::get("user_id");        $detail_data  = $detail->where(['id'=>$user_id,'type'=>1])->select();        $money        = $user->where('id',$user_id)->value('money');        $this->assign('data',$detail_data);        $this->assign('money',$money);        return $this->fetch();    }    /*     * 提现     *     * */    public function extract_money(ThisUser $user){        $user_id      = Session::get("user_id");        $account      = $user->where('id',$user_id)->value('account');        $this->assign('account',$account);        //提现功能操作        //$this->error('提现功能程序小哥正在努力开发中。。。');        return $this->fetch();    }    /*     * 提现记录     *     * */    public function extract_record(MoneyDetail $detail){        $user_id  = Session::get("user_id");        $count    = $detail->where(['id'=>$user_id,'type'=>2])->count('money');        $list     = $detail->where(['id'=>$user_id,'type'=>2])->select();        $this->assign('count',$count);        $this->assign('list',$list);        return $this->fetch();    }    /*     * 提现操作     *     * */    public function take_money(Request $request,ThisUser $user){        $requests = $request->param();        $money    = $requests['money'];        $user_id  = Session::get("user_id");        $account  = $user->where('id',$user_id)->value('account');        //剩余金额        $sy_money = $account - $money;        if($sy_money >=0){            //提现操作            Db::startTrans();            try {                $user->where('id', $user_id)->update(['account', $sy_money]);                $data['user_id']     = $user_id;                $data['money']       = $money;                //$data['status']      = 0;                $data['createtime']  = time();                $data['content']     = '提现';                $data['type']        = 2;                db('money_detail')->allowField(true)->insert($data);                /*微信企业打款接口*/                Db::commit();            }catch (\Exception $e) {                 Db::rollback();                return ['code' => 400, 'message' => '数据错误等待处理'];            }            return ['code' => 200, 'message' => '提现申请成功'];        }            return ['code' => 400, 'message' => '提现申请失败'];    }    /*     * 提现说明     *     * */    public function take_info(){        return $this->fetch('info');    }    /** 我的---积分*/    public function integral(Request $request,ThisUser $user)    {        $data = Db::name('integral_info')->where('user_id', Session::get('user_id'))->select();        $total = $user->where('id', Session::get('user_id'))->value('integral');        return $this->fetch(            'integral', [                'title' => "我的积分",                'data' => $data,                'total' => $total            ]        );    }    /*     *     * 已邀请的代理商     *     * */    public function agent(ThisUser $user){        $user_id =  Session::get('user_id');        $where   = ['invited_id'=>$user_id];        if (Request::instance()->isPOST())        {            $data = Request::instance()->post();            if(!empty($data)){                $where = [                    'username' => ['like', '%' . $data['keyword'] . '%'],                ];                $this->assign("keyword", $data['keyword']);            }        }        $list   =  $user->where($where)->select();        $this->assign('list',$list);        return $this->fetch();    }    /*     *     * 我的 团队     *     * */    public function myteam(Request $request,ThisUser $user){        $user_id      = Session::get('user_id');        $level_id     = $user->where('id',$user_id)->value('level_id');        if($level_id<4){            $this->error('您尚无团队信息');            return false;        }        $star_lv  = 1;        $get_data = $request->param();        if (!empty($get_data['star_lv'])) {            $star_lv  = $get_data['star_lv'];        }        $where = [            'invited_id' => $user_id,            'star_lv'    => $star_lv,        ];        $data = $user->where($where)->field('username,level_id,picurl,create_time,star_lv')->select();        $where['star_lv'] = 1;        $count_one   = $user->where($where)->count();        $where['star_lv'] = 2;        $count_two   = $user->where($where)->count();        $where['star_lv'] = 3;        $count_three = $user->where($where)->count();        $this->assign('star_lv',$star_lv);        $this->assign('c_one',$count_one);        $this->assign('c_two',$count_two);        $this->assign('c_three',$count_three);        $this->assign('data',$data);        return $this->fetch();    }}