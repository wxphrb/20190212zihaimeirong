<?phpnamespace app\home\controller;use app\home\model\Banner;use app\home\model\Goods;use app\home\model\User;use think\Controller;use think\Db;use think\Request;use think\Session;use think\Url;class Index extends Base{    protected function _initialize()    {        parent::_initialize();        //底部默认选中        $this->assign('mo_foot',1);    }	public function index(Request $requests ,Goods $goods , User $user , Banner $banner){        $request = $requests->request();        //轮播图        $user_id  = Session::get('user_id');        $level_id = 0;        $banner_map = [            //'is_pc' => 0,            'status'=>1        ];        $data['banner'] =$banner->where($banner_map)->field('id,picurl,target,content')->order('create_time desc')->select();        //热门分类        $data['goods_type'] = db('goods_type')->where('parentid',1)->select();        if(!empty($user_id)){            $level =  $user->where('id',$user_id)->field('level_id,temporary_level')->find();            if($level['temporary_level']>0){                $level_id = $level['temporary_level'];            }else{                $level_id = $level['level_id'];            }        }        //热门推荐        /*$hot_goods = db('goods')->where(['hot'=>1,'status'=>1])->order('id desc')->limit(4)->field('id,picurl,title,saleprice,sell,goodsattr,kucun_all')->select();        //对应等级显示对象价格        if(!empty($level_id) && $level_id>0){              foreach($hot_goods as &$v){                  $goodsattr = unserialize($v['goodsattr']);                    foreach($goodsattr as $kk=>$vv){                        $ext = 'price'.$level_id;                        $v['saleprice']   = $vv[$ext];                        $v['kucun']       = $vv['kucun'];                        $v['gg']          = $kk;                        break;                    }              }        }*/        $where = ['hot'=>1,'status'=>1];        $hot_goods = $goods->goods_regroup($where,'',$level_id);	    return $this->fetch(	        'index',[	            'title'     => "首页",	            'data'      => $data,                'hot_goods' => $hot_goods,                'level_id'  => $level_id,            ]        );	}    public function bannerWeb(Request $request){        $post_data = $request->param();        $content = Db::name("banner")->where("id", $post_data['id'])->value("content");        return $this->fetch(            'bannerweb',[                'title'=>"详情页",                'data'=>$content            ]        );    }    //我要加盟    public function joinIn(){        $this->assign('title','我要加盟');        return $this->fetch();    }    //公司介绍    public function info(Request $request){        $this->assign('title','公司介绍');        return $this->fetch();    }    //加盟申请    public function message(Request $requests){        $request            = $requests->param();        $request['user_id'] = Session::get('user_id');        $user_data          = db('user')->where('id',$request['user_id'])->field('level_id,mobile')->find();        $user_lv       = $user_data['level_id'];        $user_mobile   = $user_data['mobile'];        $request['create_time'] = time();        if(empty($request['user_id']) || (empty($user_lv) && $user_lv >0)){            $this->error('请登录');        }        if($user_mobile != $request['mobile']){            $this->error('手机号码与登录号码不符');        }        if($user_lv >= $request['level_id']){            $this->error('申请等级必须大于当前等级');        }        $message = Db::name("feedback")->where(['user_id'=>$request['user_id']])->find();        if(!empty($message) && $message['level_id'] >= $request['level_id']){            $this->error('您已提交过申请，请耐心等待审核');        }        $res = Db::name("feedback")->insert($request);        if($res){            $this->success('申请成功');        }else{            $this->error('申请失败');        }    }}